<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Recommended AWS CDK Project Structure for Monolithic Python Applications - SoftWhat?</title><link rel="icon" type="image/png" href=icons/favicon.ico /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Recommended AWS CDK Project Structure for Monolithic Python Applications" />
<meta property="og:description" content="In my Recommended AWS CDK project structure for Python applications blog post, the application is a component (User Management Backend) with a dedicated Git repository and a single pipeline. This is the option #4 in the figure below.
Source: https://d1.awsstatic.com/events/Summits/reinvent2022/DOP321_Organize-application-components-into-repositories-and-pipelines-with-AWS-CDK.pdf Some builders initially prefer to manage the workload as a monolith in a single repository with one or more pipelines. In this post, I describe an application for options #1 and #2 in the above figure." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://softwhat.com/recommended-aws-cdk-project-structure-for-monolithic-python-applications/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Recommended AWS CDK Project Structure for Monolithic Python Applications"/>
<meta name="twitter:description" content="In my Recommended AWS CDK project structure for Python applications blog post, the application is a component (User Management Backend) with a dedicated Git repository and a single pipeline. This is the option #4 in the figure below.
Source: https://d1.awsstatic.com/events/Summits/reinvent2022/DOP321_Organize-application-components-into-repositories-and-pipelines-with-AWS-CDK.pdf Some builders initially prefer to manage the workload as a monolith in a single repository with one or more pipelines. In this post, I describe an application for options #1 and #2 in the above figure."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://softwhat.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://softwhat.com/css/main.css" /><link rel="stylesheet" type="text/css" href="https://softwhat.com/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://softwhat.com/js/feather.min.js"></script>
	
	<script src="https://softwhat.com/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://softwhat.com/">
	<h1 class="site-title"><a href="https://softwhat.com/">SoftWhat?</a></h1>
	<div class="site-description"><h2>Architecture and Software Engineering tidbits</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/alexpulver" title="Github"><i data-feather="github"></i></a><a href="https://linkedin.com/in/alexpulver" title="LinkedIn"><i data-feather="linkedin"></i></a><a href="https://twitter.com/alex_pulver" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Recommended AWS CDK Project Structure for Monolithic Python Applications</h1>
			<div class="meta">Posted at &mdash; Mar 25, 2023</div>
		</div>

		<div class="markdown">
			<p>In my <a href="https://aws.amazon.com/blogs/developer/recommended-aws-cdk-project-structure-for-python-applications/">Recommended AWS CDK project structure for Python applications</a> blog post, the application is a component (User Management Backend) with a dedicated Git repository and a single pipeline. This is the option #4 in the figure below.</p>
<figure><img src="/images/recommended-aws-cdk-project-structure-for-monolithic-python-applications-1.png"/><figcaption>
            <h4>Source: https://d1.awsstatic.com/events/Summits/reinvent2022/DOP321_Organize-application-components-into-repositories-and-pipelines-with-AWS-CDK.pdf</h4>
        </figcaption>
</figure>

<p>Some builders initially prefer to manage the workload as a monolith in a single repository with one or more pipelines. In this post, I describe an application for options #1 and #2 in the above figure.</p>
<h2 id="concepts">Concepts</h2>
<p>I use the following <a href="https://docs.aws.amazon.com/wellarchitected/latest/framework/definitions.html">terminology</a> from the AWS Well-Architected Framework:</p>
<ul>
<li>A <strong>component</strong> is the code, configuration, and AWS Resources that together deliver against a requirement. A component is often the unit of technical ownership, and is decoupled from other components.</li>
<li>The term <strong>workload</strong> is used to identify a set of components that together deliver business value. A workload is usually the level of detail that business and technology leaders communicate about.</li>
<li>We think about <strong>architecture</strong> as being how components work together in a workload. How components communicate and interact is often the focus of architecture diagrams.</li>
</ul>
<h2 id="architecture">Architecture</h2>
<p>I am extending the User Management workload to 3 components: <code>Users UI</code>, <code>Users API</code> (<code>Backend</code> in the original post), and <code>Chatbot API</code>.</p>
<figure><img src="/images/recommended-aws-cdk-project-structure-for-monolithic-python-applications-2.png"/><figcaption>
            <h4>User Management workload</h4>
        </figcaption>
</figure>

<h2 id="project-structure">Project structure</h2>
<p>The project now has a top-level package for the workload. The workload package contains a sub-package for each component.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>usermanagement/
</span></span><span style="display:flex;"><span>    chatbot_api/
</span></span><span style="display:flex;"><span>        nlp/
</span></span><span style="display:flex;"><span>            runtime/
</span></span><span style="display:flex;"><span>                lambda_function.py
</span></span><span style="display:flex;"><span>        component.py  <span style="color:#586e75"># defines NLP infrastructure</span>
</span></span><span style="display:flex;"><span>    users_api/
</span></span><span style="display:flex;"><span>        api/
</span></span><span style="display:flex;"><span>            runtime/
</span></span><span style="display:flex;"><span>                lambda_function.py
</span></span><span style="display:flex;"><span>            infrastructure.py
</span></span><span style="display:flex;"><span>        database/
</span></span><span style="display:flex;"><span>            infrastructure.py
</span></span><span style="display:flex;"><span>        operations/
</span></span><span style="display:flex;"><span>            infrastructure.py
</span></span><span style="display:flex;"><span>        component.py
</span></span><span style="display:flex;"><span>    users_ui/
</span></span><span style="display:flex;"><span>        spa/
</span></span><span style="display:flex;"><span>            runtime/
</span></span><span style="display:flex;"><span>                index.html
</span></span><span style="display:flex;"><span>        component.py  <span style="color:#586e75"># defines CDN and SPA infrastructure</span>
</span></span><span style="display:flex;"><span>    workload.py
</span></span><span style="display:flex;"><span>app.py
</span></span><span style="display:flex;"><span>toolchain.py
</span></span></code></pre></div><p><em>Note:</em> The infrastructure for Chatbot API and Users UI logical units (NLP and CDN/SPA respectively) is quite simple. Hence, I decided to define the infrastructure directly in the <code>component.py</code> file. I did create dedicated directories for the logical units&rsquo; runtime code as it is more involved.</p>
<p>The new <code>usermanagement/workload.py</code> module composes the components into the deployment layout. But first, I need to decide on the deployment layout itself ðŸ˜ƒ. The options range from workload as a single stack to each component as one or more stacks. I will describe both below.</p>
<p>Let&rsquo;s go through the related changes in <code>app.py</code>, <code>usermanagement/users_api/component.py</code> (<code>backend/component.py</code> in the original blog post), <code>toolchain.py</code>, and introduce the new <code>usermanagement/workload.py</code>.</p>
<h2 id="workload-as-a-single-stack">Workload as a single stack</h2>
<p><strong>app.py</strong></p>
<p>This time, I import the workload class instead of the component class. I also change <code>constants.APP_NAME</code> from <code>UserManagementBackend</code> (component) to <code>UserManagement</code> (workload).</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># The AWS CDK application entry point</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> constants
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.workload <span style="color:#719e07">import</span> UserManagement
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> toolchain <span style="color:#719e07">import</span> Toolchain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#719e07">=</span> cdk<span style="color:#719e07">.</span>App()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75"># Workload sandbox stack</span>
</span></span><span style="display:flex;"><span>UserManagement(
</span></span><span style="display:flex;"><span>    app,
</span></span><span style="display:flex;"><span>    constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;Sandbox&#34;</span>,
</span></span><span style="display:flex;"><span>    api_lambda_reserved_concurrency<span style="color:#719e07">=</span><span style="color:#2aa198">1</span>,
</span></span><span style="display:flex;"><span>    database_dynamodb_billing_mode<span style="color:#719e07">=</span>dynamodb<span style="color:#719e07">.</span>BillingMode<span style="color:#719e07">.</span>PAY_PER_REQUEST,
</span></span><span style="display:flex;"><span>    env<span style="color:#719e07">=</span>cdk<span style="color:#719e07">.</span>Environment(
</span></span><span style="display:flex;"><span>        account<span style="color:#719e07">=</span>os<span style="color:#719e07">.</span>environ[<span style="color:#2aa198">&#34;CDK_DEFAULT_ACCOUNT&#34;</span>],
</span></span><span style="display:flex;"><span>        region<span style="color:#719e07">=</span>os<span style="color:#719e07">.</span>environ[<span style="color:#2aa198">&#34;CDK_DEFAULT_REGION&#34;</span>],
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75"># Toolchain stack (defines the continuous deployment pipeline)</span>
</span></span><span style="display:flex;"><span>Toolchain(
</span></span><span style="display:flex;"><span>    app,
</span></span><span style="display:flex;"><span>    constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;Toolchain&#34;</span>,
</span></span><span style="display:flex;"><span>    env<span style="color:#719e07">=</span>cdk<span style="color:#719e07">.</span>Environment(account<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;111111111111&#34;</span>, region<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;eu-west-1&#34;</span>),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#719e07">.</span>synth()
</span></span></code></pre></div><p><strong>usermanagement/workload.py</strong></p>
<p>The <code>UserManagement</code> class implements a workload stack that composes the components together.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># User Management workload deployment layout</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.chatbot_api.component <span style="color:#719e07">import</span> ChatbotAPI
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.component <span style="color:#719e07">import</span> UsersAPI
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_ui.component <span style="color:#719e07">import</span> UsersUI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">UserManagement</span>(cdk<span style="color:#719e07">.</span>Stack):
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> __init__(
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>        scope: cdk<span style="color:#719e07">.</span>Construct,
</span></span><span style="display:flex;"><span>        id_: <span style="color:#b58900">str</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">*</span>,
</span></span><span style="display:flex;"><span>        api_lambda_reserved_concurrency: <span style="color:#b58900">int</span>,
</span></span><span style="display:flex;"><span>        database_dynamodb_billing_mode: dynamodb<span style="color:#719e07">.</span>BillingMode,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">**</span>kwargs: Any,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#b58900">super</span>()<span style="color:#719e07">.</span>__init__(scope, id_, <span style="color:#719e07">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        chatbot_api <span style="color:#719e07">=</span> ChatbotAPI(<span style="color:#268bd2">self</span>, <span style="color:#2aa198">&#34;ChatbotAPI&#34;</span>)
</span></span><span style="display:flex;"><span>        users_api <span style="color:#719e07">=</span> UsersAPI(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;UsersAPI&#34;</span>,
</span></span><span style="display:flex;"><span>            api_lambda_reserved_concurrency<span style="color:#719e07">=</span><span style="color:#2aa198">1</span>,
</span></span><span style="display:flex;"><span>            database_dynamodb_billing_mode<span style="color:#719e07">=</span>dynamodb<span style="color:#719e07">.</span>BillingMode<span style="color:#719e07">.</span>PAY_PER_REQUEST,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        users_ui <span style="color:#719e07">=</span> UsersUI(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;UsersUI&#34;</span>,
</span></span><span style="display:flex;"><span>            chatbot_api_endpoint<span style="color:#719e07">=</span>chatbot_api<span style="color:#719e07">.</span>endpoint,
</span></span><span style="display:flex;"><span>            users_api_endpoint<span style="color:#719e07">=</span>users_api<span style="color:#719e07">.</span>endpoint,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span><span style="color:#719e07">.</span>users_ui_endpoint <span style="color:#719e07">=</span> cdk<span style="color:#719e07">.</span>CfnOutput(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;UsersUIEndpoint&#34;</span>, 
</span></span><span style="display:flex;"><span>            value<span style="color:#719e07">=</span>users_ui<span style="color:#719e07">.</span>endpoint,
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p><strong>usermanagement/users_api/component.py</strong></p>
<p>The component becomes a construct. That also means removing <code>**kwargs</code> because the <a href="https://docs.aws.amazon.com/cdk/api/v2/python/constructs/Construct.html"><code>cdk.Construct</code></a> base class accepts only <code>scope</code> and <code>id_</code> parameters. I change the definition of the <code>self.endpoint</code> (<code>self.api_endpoint</code> in the original post) attribute from <code>cdk.CfnOutput</code> to pure value, because I want to centralize all stack outputs in <code>usermanagement/workload.py</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># Users API component</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.api.infrastructure <span style="color:#719e07">import</span> API
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.database.infrastructure <span style="color:#719e07">import</span> Database
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.monitoring.infrastructure <span style="color:#719e07">import</span> Monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">UsersAPI</span>(cdk<span style="color:#719e07">.</span>Construct):
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> __init__(
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>        scope: cdk<span style="color:#719e07">.</span>Construct,
</span></span><span style="display:flex;"><span>        id_: <span style="color:#b58900">str</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">*</span>,
</span></span><span style="display:flex;"><span>        api_lambda_reserved_concurrency: <span style="color:#b58900">int</span>,
</span></span><span style="display:flex;"><span>        database_dynamodb_billing_mode: dynamodb<span style="color:#719e07">.</span>BillingMode,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#b58900">super</span>()<span style="color:#719e07">.</span>__init__(scope, id_)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>        database <span style="color:#719e07">=</span> Database(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;Database&#34;</span>, 
</span></span><span style="display:flex;"><span>            dynamodb_billing_mode<span style="color:#719e07">=</span>database_dynamodb_billing_mode
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        api <span style="color:#719e07">=</span> API(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;API&#34;</span>,
</span></span><span style="display:flex;"><span>            dynamodb_table_name<span style="color:#719e07">=</span>database<span style="color:#719e07">.</span>dynamodb_table<span style="color:#719e07">.</span>table_name,
</span></span><span style="display:flex;"><span>            lambda_reserved_concurrency<span style="color:#719e07">=</span>api_lambda_reserved_concurrency,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        Monitoring(<span style="color:#268bd2">self</span>, <span style="color:#2aa198">&#34;Monitoring&#34;</span>, database<span style="color:#719e07">=</span>database, api<span style="color:#719e07">=</span>api)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        database<span style="color:#719e07">.</span>dynamodb_table<span style="color:#719e07">.</span>grant_read_write_data(api<span style="color:#719e07">.</span>lambda_function)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span><span style="color:#719e07">.</span>endpoint <span style="color:#719e07">=</span> api<span style="color:#719e07">.</span>api_gateway_http_api<span style="color:#719e07">.</span>url
</span></span></code></pre></div><p><strong>toolchain.py</strong></p>
<p>The only change here is to use <code>UserManagement</code> class representing the workload.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># Continuous deployment pipeline</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> aws_cdk <span style="color:#719e07">as</span> cdk
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> aws_cdk <span style="color:#719e07">import</span> pipelines
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> constants
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.workload <span style="color:#719e07">import</span> UserManagement
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">Toolchain</span>(cdk<span style="color:#719e07">.</span>Stack):
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> __init__(<span style="color:#268bd2">self</span>, scope: cdk<span style="color:#719e07">.</span>Construct, id_: <span style="color:#b58900">str</span>, <span style="color:#719e07">**</span>kwargs: Any):
</span></span><span style="display:flex;"><span>        <span style="color:#b58900">super</span>()<span style="color:#719e07">.</span>__init__(scope, id_, <span style="color:#719e07">**</span>kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span>        pipeline <span style="color:#719e07">=</span> pipelines<span style="color:#719e07">.</span>CodePipeline(<span style="color:#719e07">...</span>)
</span></span><span style="display:flex;"><span>        Toolchain<span style="color:#719e07">.</span>_add_production_stage(codepipeline)
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">_add_production_stage</span>(<span style="color:#268bd2">self</span>, pipeline: pipelines<span style="color:#719e07">.</span>CodePipeline) <span style="color:#719e07">-&gt;</span> <span style="color:#cb4b16">None</span>:
</span></span><span style="display:flex;"><span>        production <span style="color:#719e07">=</span> cdk<span style="color:#719e07">.</span>Stage(
</span></span><span style="display:flex;"><span>            pipeline,
</span></span><span style="display:flex;"><span>            PRODUCTION_ENV_NAME,
</span></span><span style="display:flex;"><span>            env<span style="color:#719e07">=</span>cdk<span style="color:#719e07">.</span>Environment(
</span></span><span style="display:flex;"><span>                account<span style="color:#719e07">=</span>PRODUCTION_ENV_ACCOUNT, region<span style="color:#719e07">=</span>PRODUCTION_ENV_REGION
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        usermanagement <span style="color:#719e07">=</span> UserManagement(
</span></span><span style="display:flex;"><span>            production,
</span></span><span style="display:flex;"><span>            constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> PRODUCTION_ENV_NAME,
</span></span><span style="display:flex;"><span>            api_lambda_reserved_concurrency<span style="color:#719e07">=</span><span style="color:#2aa198">10</span>,
</span></span><span style="display:flex;"><span>            database_dynamodb_billing_mode<span style="color:#719e07">=</span>dynamodb<span style="color:#719e07">.</span>BillingMode<span style="color:#719e07">.</span>PROVISIONED,
</span></span><span style="display:flex;"><span>            stack_name<span style="color:#719e07">=</span>constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> PRODUCTION_ENV_NAME,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span>        pipeline<span style="color:#719e07">.</span>add_stage(production, post<span style="color:#719e07">=</span>[smoke_test])
</span></span></code></pre></div><h2 id="each-component-as-one-or-more-stacks">Each component as one or more stacks</h2>
<p><strong>app.py</strong></p>
<p>I still import and use the workload class here. You can notice that I specify a new <code>stack_namespace</code> parameter instead of ID parameter. The next <code>usermanagement/workload.py</code> section dives into that.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># The AWS CDK application entry point</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> constants
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.workload <span style="color:#719e07">import</span> UserManagement
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> toolchain <span style="color:#719e07">import</span> Toolchain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#719e07">=</span> cdk<span style="color:#719e07">.</span>App()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75"># Workload sandbox stack</span>
</span></span><span style="display:flex;"><span>UserManagement(
</span></span><span style="display:flex;"><span>    app,
</span></span><span style="display:flex;"><span>    stack_namespace<span style="color:#719e07">=</span>constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;Sandbox&#34;</span>,
</span></span><span style="display:flex;"><span>    api_lambda_reserved_concurrency<span style="color:#719e07">=</span><span style="color:#2aa198">1</span>,
</span></span><span style="display:flex;"><span>    database_dynamodb_billing_mode<span style="color:#719e07">=</span>dynamodb<span style="color:#719e07">.</span>BillingMode<span style="color:#719e07">.</span>PAY_PER_REQUEST,
</span></span><span style="display:flex;"><span>    env<span style="color:#719e07">=</span>cdk<span style="color:#719e07">.</span>Environment(
</span></span><span style="display:flex;"><span>        account<span style="color:#719e07">=</span>os<span style="color:#719e07">.</span>environ[<span style="color:#2aa198">&#34;CDK_DEFAULT_ACCOUNT&#34;</span>],
</span></span><span style="display:flex;"><span>        region<span style="color:#719e07">=</span>os<span style="color:#719e07">.</span>environ[<span style="color:#2aa198">&#34;CDK_DEFAULT_REGION&#34;</span>],
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75"># Toolchain stack (defines the continuous deployment pipeline)</span>
</span></span><span style="display:flex;"><span>Toolchain(
</span></span><span style="display:flex;"><span>    app,
</span></span><span style="display:flex;"><span>    constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;Toolchain&#34;</span>,
</span></span><span style="display:flex;"><span>    env<span style="color:#719e07">=</span>cdk<span style="color:#719e07">.</span>Environment(account<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;111111111111&#34;</span>, region<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;eu-west-1&#34;</span>),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#719e07">.</span>synth()
</span></span></code></pre></div><p><strong>usermanagement/workload.py</strong></p>
<p>The <code>UserManagement</code> class implements a workload container object (<strong>not a stack</strong>) that composes the components together. It passes the <code>scope</code> to each component stack. The new <code>stack_namespace</code> parameter sets prefix for component stacks ID and name. Now, I set the stack name in <code>UserManagement</code> class and not in the toolchain. This is because the toolchain can&rsquo;t pass a single stack name as it did in the single stack option. Hence, the <code>UserManagement</code> container object should assume that responsiblity based on the <code>stack_namespace</code> parameter.</p>
<p>Since the <code>UserManagement</code> class is not a stack, it doesn&rsquo;t (and can&rsquo;t) define stack outputs. The component stacks define their own outputs. I can still define dependencies between the stacks here if needed (explicitly or implicitly).</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># User Management workload</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.chatbot_api.component <span style="color:#719e07">import</span> ChatbotAPI
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.component <span style="color:#719e07">import</span> UsersAPI
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_ui.component <span style="color:#719e07">import</span> UsersUI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">UserManagement</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> __init__(
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>        scope: cdk<span style="color:#719e07">.</span>Construct,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">*</span>,
</span></span><span style="display:flex;"><span>        stack_namespace: <span style="color:#b58900">str</span>,
</span></span><span style="display:flex;"><span>        api_lambda_reserved_concurrency: <span style="color:#b58900">int</span>,
</span></span><span style="display:flex;"><span>        database_dynamodb_billing_mode: dynamodb<span style="color:#719e07">.</span>BillingMode,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">**</span>kwargs: Any,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        chatbot_api <span style="color:#719e07">=</span> ChatbotAPI(
</span></span><span style="display:flex;"><span>            scope,
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">f</span><span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{</span>stack_namespace<span style="color:#2aa198">}</span><span style="color:#2aa198">-ChatbotAPI&#34;</span>,
</span></span><span style="display:flex;"><span>            stack_name<span style="color:#719e07">=</span><span style="color:#2aa198">f</span><span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{</span>stack_namespace<span style="color:#2aa198">}</span><span style="color:#2aa198">-ChatbotAPI&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">**</span>kwargs,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        users_api <span style="color:#719e07">=</span> UsersAPI(
</span></span><span style="display:flex;"><span>            scope,
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">f</span><span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{</span>stack_namespace<span style="color:#2aa198">}</span><span style="color:#2aa198">-UsersAPI&#34;</span>,
</span></span><span style="display:flex;"><span>            api_lambda_reserved_concurrency<span style="color:#719e07">=</span><span style="color:#2aa198">1</span>,
</span></span><span style="display:flex;"><span>            database_dynamodb_billing_mode<span style="color:#719e07">=</span>dynamodb<span style="color:#719e07">.</span>BillingMode<span style="color:#719e07">.</span>PAY_PER_REQUEST,
</span></span><span style="display:flex;"><span>            stack_name<span style="color:#719e07">=</span><span style="color:#2aa198">f</span><span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{</span>stack_namespace<span style="color:#2aa198">}</span><span style="color:#2aa198">-UsersAPI&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">**</span>kwargs,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        users_ui <span style="color:#719e07">=</span> UsersUI(
</span></span><span style="display:flex;"><span>            scope,
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">f</span><span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{</span>stack_namespace<span style="color:#2aa198">}</span><span style="color:#2aa198">-UsersUI&#34;</span>,
</span></span><span style="display:flex;"><span>            chatbot_endpoint<span style="color:#719e07">=</span>chatbot_api<span style="color:#719e07">.</span>endpoint,
</span></span><span style="display:flex;"><span>            users_api_endpoint<span style="color:#719e07">=</span>users_api<span style="color:#719e07">.</span>endpoint,
</span></span><span style="display:flex;"><span>            stack_name<span style="color:#719e07">=</span><span style="color:#2aa198">f</span><span style="color:#2aa198">&#34;</span><span style="color:#2aa198">{</span>stack_namespace<span style="color:#2aa198">}</span><span style="color:#2aa198">-UsersUI&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">**</span>kwargs,
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p><strong>usermanagement/users_api/component.py</strong></p>
<p>The implementation here is similar to the original post. The only differences are the imports namespace that starts on the workload level and the stack output attribute name.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># Users API component deployment layout</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.api.infrastructure <span style="color:#719e07">import</span> API
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.database.infrastructure <span style="color:#719e07">import</span> Database
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.users_api.monitoring.infrastructure <span style="color:#719e07">import</span> Monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">UsersAPI</span>(cdk<span style="color:#719e07">.</span>Stack):
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> __init__(
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>        scope: cdk<span style="color:#719e07">.</span>Construct,
</span></span><span style="display:flex;"><span>        id_: <span style="color:#b58900">str</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">*</span>,
</span></span><span style="display:flex;"><span>        api_lambda_reserved_concurrency: <span style="color:#b58900">int</span>,
</span></span><span style="display:flex;"><span>        database_dynamodb_billing_mode: dynamodb<span style="color:#719e07">.</span>BillingMode,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">**</span>kwargs: Any,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#b58900">super</span>()<span style="color:#719e07">.</span>__init__(scope, id_, <span style="color:#719e07">**</span>kwargs: Any,)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>        database <span style="color:#719e07">=</span> Database(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;Database&#34;</span>, 
</span></span><span style="display:flex;"><span>            dynamodb_billing_mode<span style="color:#719e07">=</span>database_dynamodb_billing_mode
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        api <span style="color:#719e07">=</span> API(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;API&#34;</span>,
</span></span><span style="display:flex;"><span>            dynamodb_table_name<span style="color:#719e07">=</span>database<span style="color:#719e07">.</span>dynamodb_table<span style="color:#719e07">.</span>table_name,
</span></span><span style="display:flex;"><span>            lambda_reserved_concurrency<span style="color:#719e07">=</span>api_lambda_reserved_concurrency,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        Monitoring(<span style="color:#268bd2">self</span>, <span style="color:#2aa198">&#34;Monitoring&#34;</span>, database<span style="color:#719e07">=</span>database, api<span style="color:#719e07">=</span>api)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        database<span style="color:#719e07">.</span>dynamodb_table<span style="color:#719e07">.</span>grant_read_write_data(api<span style="color:#719e07">.</span>lambda_function)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">self</span><span style="color:#719e07">.</span>endpoint <span style="color:#719e07">=</span> cdk<span style="color:#719e07">.</span>CfnOutput(
</span></span><span style="display:flex;"><span>            <span style="color:#268bd2">self</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#2aa198">&#34;Endpoint&#34;</span>, 
</span></span><span style="display:flex;"><span>            value<span style="color:#719e07">=</span>api<span style="color:#719e07">.</span>api_gateway_http_api<span style="color:#719e07">.</span>url,
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p><strong>toolchain.py</strong></p>
<p>Since <code>UserManagement</code> is a container object, this time the toolchain passes only the <code>stack_namespace</code> parameter. The toolchain doesn&rsquo;t pass stack ID and name parameters, because <code>UserManagement</code> defines them.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#586e75"># Continuous deployment pipeline</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> aws_cdk <span style="color:#719e07">as</span> cdk
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> aws_cdk <span style="color:#719e07">import</span> pipelines
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> constants
</span></span><span style="display:flex;"><span><span style="color:#719e07">from</span> usermanagement.workload <span style="color:#719e07">import</span> UserManagement
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">class</span> <span style="color:#268bd2">Toolchain</span>(cdk<span style="color:#719e07">.</span>Stack):
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> __init__(<span style="color:#268bd2">self</span>, scope: cdk<span style="color:#719e07">.</span>Construct, id_: <span style="color:#b58900">str</span>, <span style="color:#719e07">**</span>kwargs: Any):
</span></span><span style="display:flex;"><span>        <span style="color:#b58900">super</span>()<span style="color:#719e07">.</span>__init__(scope, id_, <span style="color:#719e07">**</span>kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span>        pipeline <span style="color:#719e07">=</span> pipelines<span style="color:#719e07">.</span>CodePipeline(<span style="color:#719e07">...</span>)
</span></span><span style="display:flex;"><span>        Toolchain<span style="color:#719e07">.</span>_add_production_stage(codepipeline)
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">def</span> <span style="color:#268bd2">_add_production_stage</span>(<span style="color:#268bd2">self</span>, pipeline: pipelines<span style="color:#719e07">.</span>CodePipeline) <span style="color:#719e07">-&gt;</span> <span style="color:#cb4b16">None</span>:
</span></span><span style="display:flex;"><span>        production <span style="color:#719e07">=</span> cdk<span style="color:#719e07">.</span>Stage(
</span></span><span style="display:flex;"><span>            pipeline,
</span></span><span style="display:flex;"><span>            PRODUCTION_ENV_NAME,
</span></span><span style="display:flex;"><span>            env<span style="color:#719e07">=</span>cdk<span style="color:#719e07">.</span>Environment(
</span></span><span style="display:flex;"><span>                account<span style="color:#719e07">=</span>PRODUCTION_ENV_ACCOUNT, region<span style="color:#719e07">=</span>PRODUCTION_ENV_REGION
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        usermanagement <span style="color:#719e07">=</span> UserManagement(
</span></span><span style="display:flex;"><span>            production,
</span></span><span style="display:flex;"><span>            stack_namespace<span style="color:#719e07">=</span>constants<span style="color:#719e07">.</span>APP_NAME <span style="color:#719e07">+</span> PRODUCTION_ENV_NAME,
</span></span><span style="display:flex;"><span>            api_lambda_reserved_concurrency<span style="color:#719e07">=</span><span style="color:#2aa198">10</span>,
</span></span><span style="display:flex;"><span>            database_dynamodb_billing_mode<span style="color:#719e07">=</span>dynamodb<span style="color:#719e07">.</span>BillingMode<span style="color:#719e07">.</span>PROVISIONED,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">...</span>
</span></span><span style="display:flex;"><span>        pipeline<span style="color:#719e07">.</span>add_stage(production, post<span style="color:#719e07">=</span>[smoke_test])
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>In this post, I described the recommended project structure for monolithic applications. The options covered range from deploying the application as a single stack to using a stack per component. You can also create more than one stack in a component if needed. I used a single pipeline for the application. If you would like to create more than one pipeline (e.g. pipeline per component), look at <a href="https://aws.amazon.com/blogs/devops/integrate-github-monorepo-with-aws-codepipeline-to-run-project-specific-ci-cd-pipelines/">Integrate GitHub monorepo with AWS CodePipeline to run project-specific CI/CD pipelines</a> blog post.</p>
<p>If you think Iâ€™ve missed something, feel free to ping me <a href="https://twitter.com/alex_pulver">@alex_pulver</a>. Happy coding!</p>

		</div>

		<div class="post-tags">
			
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Â© 2016 Alex Pulver |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script async src="https://www.googletagmanager.com/gtag/js?id=G-GLQWF9R90L"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GLQWF9R90L', { 'anonymize_ip': false });
}
</script>

<script>feather.replace()</script>
</body>
</html>
