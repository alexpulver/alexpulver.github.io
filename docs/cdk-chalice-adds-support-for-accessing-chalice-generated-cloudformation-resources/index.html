<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>cdk-chalice Adds Support for Accessing Chalice-generated CloudFormation Resources - SoftWhat?</title><link rel="icon" type="image/png" href=icons/favicon.ico /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="cdk-chalice Adds Support for Accessing Chalice-generated CloudFormation Resources" />
<meta property="og:description" content="cdk-chalice 0.8.1 adds support for accessing AWS Chalice-generated CloudFormation resources as native CDK objects. It is useful if you need to explicitly reference these resources in the broader AWS Cloud Development Kit (AWS CDK) application, or customize the resources generated by Chalice. In this blog post, I will explain how this feature works and provide an example.
The new capability is based on the CDK cloudformation-include module, which was released as a developer preview in CDK 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://softwhat.com/cdk-chalice-adds-support-for-accessing-chalice-generated-cloudformation-resources/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="cdk-chalice Adds Support for Accessing Chalice-generated CloudFormation Resources"/>
<meta name="twitter:description" content="cdk-chalice 0.8.1 adds support for accessing AWS Chalice-generated CloudFormation resources as native CDK objects. It is useful if you need to explicitly reference these resources in the broader AWS Cloud Development Kit (AWS CDK) application, or customize the resources generated by Chalice. In this blog post, I will explain how this feature works and provide an example.
The new capability is based on the CDK cloudformation-include module, which was released as a developer preview in CDK 1."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://softwhat.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://softwhat.com/css/main.css" />

	<script src="https://softwhat.com/js/feather.min.js"></script>
	
	<script src="https://softwhat.com/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title"><a href="https://softwhat.com/">SoftWhat?</a></h1>
	<div class="site-description"><h2>Architecture and Software Engineering tidbits</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/alexpulver" title="Github"><i data-feather="github"></i></a><a href="https://linkedin.com/in/alexpulver" title="LinkedIn"><i data-feather="linkedin"></i></a><a href="https://twitter.com/alex_pulver" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">cdk-chalice Adds Support for Accessing Chalice-generated CloudFormation Resources</h1>
			<div class="meta">Posted at &mdash; Sep 28, 2020</div>
		</div>

		<div class="markdown">
			<p>cdk-chalice 0.8.1 adds support for accessing AWS Chalice-generated CloudFormation resources as <strong>native CDK objects</strong>. It is useful if you need to explicitly reference these resources in the broader AWS Cloud Development Kit (AWS CDK) application, or customize the resources generated by Chalice. In this blog post, I will explain how this feature works and provide an example.</p>
<p>The new capability is based on the CDK <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/cloudformation-include-readme.html">cloudformation-include</a> module, which was released as a <a href="https://docs.aws.amazon.com/cdk/latest/guide/reference.html#aws_construct_lib_stability">developer preview</a> in CDK 1.64.1. That CDK version is now the minimal requirement for cdk-chalice. This module contains a set of classes whose goal is to facilitate working with existing CloudFormation templates in the CDK. It can be thought of as an extension of the capabilities of the <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_core.CfnInclude.html"><code>CfnInclude</code> class</a>.</p>
<p>cdk-chalice already exposed <code>Chalice.sam_template</code> attribute, but so far it provided access to read-only JSON representation of the CloudFormation template. It could not be used to modify the resources or reference them in the broader CDK application. With this release, <code>Chalice.sam_template</code> is an instance of <code>aws_cdk.cloudformation_include.CfnInclude</code> class, and includes the resources generated by Chalice. To show how the new feature can be used, I will build a simple web API using cdk-chalice. Then I will customize the IAM role of the backend AWS Lambda function to have full access to DynamoDB using the native CDK interface.</p>
<p>First, let&rsquo;s create a Python virtual environment and install the required packages:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 -m venv .venv
</span></span><span style="display:flex;"><span><span style="color:#b58900">source</span> .venv/bin/activate
</span></span><span style="display:flex;"><span>pip install aws-cdk.core aws-cdk.aws-iam <span style="color:#268bd2">attrs</span><span style="color:#719e07">==</span>20.2.0 <span style="color:#cb4b16">\
</span></span></span><span style="display:flex;"><span><span style="color:#cb4b16"></span>    cdk-chalice<span style="color:#719e07">==</span>0.8.1 <span style="color:#268bd2">chalice</span><span style="color:#719e07">==</span>1.20.1
</span></span></code></pre></div><p>The default Chalice (runtime) application example should suffice:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chalice new-project runtime
</span></span></code></pre></div><p>Now I will create the CDK (infrastructure) application:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir infrastructure; <span style="color:#b58900">cd</span> infrastructure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#2aa198">&lt;&lt;EOF &gt; cdk.json
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">{
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">  &#34;app&#34;: &#34;python app.py&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">}
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#2aa198">&lt;&lt;EOF &gt; app.py
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">import os
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">from aws_cdk import (
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">    core as cdk,
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">    aws_iam as iam
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">from cdk_chalice import Chalice
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">class WebApi(cdk.Stack):
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">    def __init__(self, scope: cdk.Construct, id: str, **kwargs) -&gt; None:
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        super().__init__(scope, id, **kwargs)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        runtime_source_dir = os.path.join(
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">            os.path.dirname(__file__), os.pardir, &#39;runtime&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        self.chalice = Chalice(
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">            self, &#39;WebApi&#39;, source_dir=runtime_source_dir, 
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">            stage_config={&#39;api_gateway_stage&#39;: &#39;v1&#39;})
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        api_handler_role = self.chalice.sam_template.get_resource(
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">            &#39;DefaultRole&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        print(f&#39;type(api_handler_role) = {type(api_handler_role)}&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        dynamodb_policy = iam.ManagedPolicy.from_aws_managed_policy_name(
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">            &#39;AmazonDynamoDBFullAccess&#39;).managed_policy_arn
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">        api_handler_role.managed_policy_arns = [dynamodb_policy]
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">app = cdk.App()
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">dev_env = cdk.Environment(account=os.environ[&#39;CDK_DEFAULT_ACCOUNT&#39;],
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">                          region=os.environ[&#39;CDK_DEFAULT_REGION&#39;])
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">WebApi(app, &#39;WebApiDev&#39;, env=dev_env)
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">app.synth()
</span></span></span><span style="display:flex;"><span><span style="color:#2aa198">EOF</span>
</span></span></code></pre></div><p>In order to know the name of the resource for calling <code>self.chalice.sam_template.get_resource('&lt;logical ID&gt;')</code> method (like <code>'DefaultRole'</code> above), currently you should synthesize the application, and find the relevant resource logical ID in the template. In our case, I am looking for an IAM role, and will use <code>jq</code> to look it up (<a href="https://stedolan.github.io/jq/download/">install jq</a> if needed). To synthesize the template:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cdk synth
</span></span></code></pre></div><p>Now I can search for logical ID of the IAM role:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ jq <span style="color:#2aa198">&#39;.Resources | to_entries[] | select(.value.Type == &#34;AWS::IAM::Role&#34;) | .key&#39;</span> <span style="color:#cb4b16">\
</span></span></span><span style="display:flex;"><span><span style="color:#cb4b16"></span>    cdk.out/WebApiDev.template.json 
</span></span><span style="display:flex;"><span><span style="color:#2aa198">&#34;DefaultRole&#34;</span>
</span></span></code></pre></div><p>To show you that <code>api_handler_role</code> variable is indeed a native CDK object, I added a small print in the class code above. Let&rsquo;s synthesize the stack again, but this time look at the first few lines of the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cdk synth | head -n <span style="color:#2aa198">5</span>
</span></span><span style="display:flex;"><span>Packaging Chalice app <span style="color:#719e07">for</span> WebApiDev
</span></span><span style="display:flex;"><span>Creating deployment package.
</span></span><span style="display:flex;"><span>type<span style="color:#719e07">(</span>api_handler_role<span style="color:#719e07">)</span> <span style="color:#719e07">=</span> &lt;class <span style="color:#2aa198">&#39;aws_cdk.aws_iam.CfnRole&#39;</span>&gt;
</span></span><span style="display:flex;"><span>Transform: AWS::Serverless-2016-10-31
</span></span><span style="display:flex;"><span>AWSTemplateFormatVersion: <span style="color:#2aa198">&#34;2010-09-09&#34;</span>
</span></span></code></pre></div><p>You can see that type of <code>api_handler_role</code> variable is <code>&lt;class 'aws_cdk.aws_iam.CfnRole'&gt;</code>. This is a native CDK CloudFormation (L1) construct object. It can be referenced in the broader CDK application, or customized using the construct interface. In this example, I added a DynamoDB managed policy, and you can see that it was applied to the final template:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ jq <span style="color:#2aa198">&#39;.Resources.DefaultRole.Properties.ManagedPolicyArns&#39;</span> cdk.out/WebApiDev.template.json
</span></span><span style="display:flex;"><span><span style="color:#719e07">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#2aa198">&#34;Fn::Join&#34;</span>: <span style="color:#719e07">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#2aa198">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;arn:&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#2aa198">&#34;Ref&#34;</span>: <span style="color:#2aa198">&#34;AWS::Partition&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#2aa198">&#34;:iam::aws:policy/AmazonDynamoDBFullAccess&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#719e07">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">]</span>
</span></span></code></pre></div><p>If you have any feedback, I would be glad to hear it! Feel free to <a href="https://github.com/alexpulver/cdk-chalice/issues/new/choose">open an issue</a> in the cdk-chalice repository.</p>

		</div>

		<div class="post-tags">
			
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © 2016-2020 Alex Pulver |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-78532010-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
